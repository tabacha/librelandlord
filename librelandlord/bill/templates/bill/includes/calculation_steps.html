{% comment %}Reusable calculation steps display for a contribution{% endcomment %}

{% comment %}
Kompakte Darstellung:
- Bei Multiplikation/Division: Verschachtelte Berechnungen inline in Klammern
  Beispiel: (16,0 m³ - 12,0 m³) * 28,6 % = 1,1 m³
- Bei Addition/Subtraktion: Alle Werte auf einer Zeile
  Beispiel: 3427,6 kWh - 1430,2 kWh - 444,0 kWh = 1045,9 kWh
{% endcomment %}

<!-- Zählerstände der verschachtelten Berechnungen anzeigen -->
{% for arg_result in contrib.consumption_result.argument_results %}
    {% if arg_result.source_type == 'nested_calculation' and arg_result.nested_result %}
        {% for nested_step in arg_result.nested_result.calculation_steps %}
            {% include 'bill/includes/meter_readings_table.html' with step=nested_step %}
        {% endfor %}
    {% endif %}
{% endfor %}

<!-- Normale Zählerstände der Hauptberechnung -->
{% for step in contrib.consumption_result.calculation_steps %}
{% include 'bill/includes/meter_readings_table.html' with step=step %}
{% endfor %}

<!-- Kompakte Formel-Anzeige -->
{% if contrib.consumption_result.formula_display %}
<div class="calculation-step">
    {% comment %}Erklärungen über der Formel - auch aus nested calculations{% endcomment %}

    {% comment %}Erklärungen aus nested calculations{% endcomment %}
    {% for arg_result in contrib.consumption_result.argument_results %}
        {% if arg_result.source_type == 'nested_calculation' and arg_result.nested_result %}
            {% for nested_step in arg_result.nested_result.calculation_steps %}
                {% if nested_step.step_type == 'operation' %}
                    {% if nested_step.operand1_label %}
                        <div style="color: #666; font-style: italic; margin-bottom: 3px; font-size: 0.9em;">
                            ({% if nested_step.operand1_display %}{{ nested_step.operand1_display|floatformat:1 }} {{ nested_step.operand1_display_unit }}{% else %}{{ nested_step.operand1|floatformat:1 }} {{ nested_step.operand1_unit }}{% endif %} = {{ nested_step.operand1_label }})
                        </div>
                    {% endif %}
                    {% if nested_step.operand2_label %}
                        <div style="color: #666; font-style: italic; margin-bottom: 3px; font-size: 0.9em;">
                            ({% if nested_step.operand2_display %}{{ nested_step.operand2_display|floatformat:1 }} {{ nested_step.operand2_display_unit }}{% else %}{{ nested_step.operand2|floatformat:1 }} {{ nested_step.operand2_unit }}{% endif %} = {{ nested_step.operand2_label }})
                        </div>
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endfor %}

    {% comment %}Erklärungen aus der Hauptberechnung{% endcomment %}
    {% for step in contrib.consumption_result.calculation_steps %}
        {% if step.step_type == 'operation' %}
            {% if step.operand1_label %}
                <div style="color: #666; font-style: italic; margin-bottom: 3px; font-size: 0.9em;">
                    ({% if step.operand1_display %}{{ step.operand1_display|floatformat:1 }} {{ step.operand1_display_unit }}{% else %}{{ step.operand1|floatformat:1 }} {{ step.operand1_unit }}{% endif %} = {{ step.operand1_label }})
                </div>
            {% endif %}
            {% if step.operand2_label %}
                <div style="color: #666; font-style: italic; margin-bottom: 3px; font-size: 0.9em;">
                    ({% if step.operand2_display %}{{ step.operand2_display|floatformat:1 }} {{ step.operand2_display_unit }}{% else %}{{ step.operand2|floatformat:1 }} {{ step.operand2_unit }}{% endif %} = {{ step.operand2_label }})
                </div>
            {% endif %}
        {% endif %}
    {% endfor %}

    <span class="calc-cell">{{ contrib.consumption_result.formula_display }} =</span>
    <span class="consumption-cell">
        <strong>{{ contrib.consumption_result.formula_result_display }}</strong>
    </span>
</div>
{% endif %}

{% if contrib.consumption_result.calculation_str %}
<div class="calculation-step">
    <span class="calc-cell">{{ contrib.consumption_result.calculation_str_left }} =</span>
    <span class="consumption-cell"><strong>{{ contrib.consumption_result.calculation_result }}</strong></span>
</div>
{% endif %}
