{% comment %}Reusable calculation steps display for a contribution{% endcomment %}

<!-- ZÃ¤hlerstÃ¤nde und verschachtelte Berechnungen -->
{% for arg_result in contrib.consumption_result.argument_results %}
    {% if arg_result.source_type == 'nested_calculation' and arg_result.nested_result %}
        <!-- Verschachtelte Berechnung -->
        <div style="margin: 15px 0; padding: 10px; background: #f0f0f0; border-left: 4px solid #ff9800;">
            <h5 style="margin: 0 0 10px 0; color: #ff9800;">
                ğŸ”— Verschachtelte Berechnung: {{ arg_result.nested_result.consumption_calc.name }}
            </h5>

            <!-- Rekursiv: ZÃ¤hlerstÃ¤nde der verschachtelten Berechnung -->
            {% for nested_step in arg_result.nested_result.calculation_steps %}
                {% include 'bill/includes/meter_readings_table.html' with step=nested_step %}
            {% endfor %}

            <!-- Rekursiv: Berechnungsschritte der verschachtelten Berechnung -->
            {% for nested_step in arg_result.nested_result.calculation_steps %}
                {% if nested_step.step_type == 'operation' %}
                <div class="calculation-step step-{{ nested_step.step_type }}" style="background: #f8f8f8;">
                    {% if nested_step.operand1_label or nested_step.operand2_label %}
                    <div style="color: #666; font-style: italic; margin-bottom: 3px; font-size: 0.9em;">
                        {% if nested_step.operand1_label %}
                            ({% if nested_step.operand1_display %}{{ nested_step.operand1_display|floatformat:1 }} {{ nested_step.operand1_display_unit }}{% else %}{{ nested_step.operand1|floatformat:1 }} {{ nested_step.operand1_unit }}{% endif %} = {{ nested_step.operand1_label }})
                        {% endif %}
                        {% if nested_step.operand2_label %}
                            ({% if nested_step.operand2_display %}{{ nested_step.operand2_display|floatformat:1 }} {{ nested_step.operand2_display_unit }}{% else %}{{ nested_step.operand2|floatformat:1 }} {{ nested_step.operand2_unit }}{% endif %} = {{ nested_step.operand2_label }})
                        {% endif %}
                    </div>
                    {% endif %}
                    <span class="calc-cell">
                        {% if nested_step.operand1_display %}
                            {{ nested_step.operand1_display|floatformat:1 }} {{ nested_step.operand1_display_unit }}
                        {% else %}
                            {{ nested_step.operand1|floatformat:1 }} {{ nested_step.operand1_unit }}
                        {% endif %}
                        {{ nested_step.operator }}
                        {% if nested_step.operand2_display %}
                            {{ nested_step.operand2_display|floatformat:1 }} {{ nested_step.operand2_display_unit }}
                        {% else %}
                            {{ nested_step.operand2|floatformat:1 }} {{ nested_step.operand2_unit }}
                        {% endif %}
                        =
                    </span>
                    <span class="consumption-cell">
                        <strong>{{ nested_step.result|floatformat:1 }} {{ nested_step.unit }}</strong>
                    </span>
                </div>
                {% endif %}
            {% endfor %}

            <div style="margin-top: 10px; padding: 8px; background: white; border: 1px solid #ddd; text-align: right;">
                <strong>Ergebnis:</strong> {{ arg_result.nested_result.final_result|floatformat:1 }}
            </div>
        </div>
    {% endif %}
{% endfor %}

<!-- Normale ZÃ¤hlerstÃ¤nde der Hauptberechnung -->
{% for step in contrib.consumption_result.calculation_steps %}
{% include 'bill/includes/meter_readings_table.html' with step=step %}
{% endfor %}

<!-- Berechnungsschritte der Hauptberechnung -->
{% for step in contrib.consumption_result.calculation_steps %}
{% if step.step_type == 'operation' %}
<div class="calculation-step step-{{ step.step_type }}">
    {% if step.operand1_label or step.operand2_label %}
    <div style="color: #666; font-style: italic; margin-bottom: 3px; font-size: 0.9em;">
        {% if step.operand1_label %}
            ({% if step.operand1_display %}{{ step.operand1_display|floatformat:1 }} {{ step.operand1_display_unit }}{% else %}{{ step.operand1|floatformat:1 }} {{ step.operand1_unit }}{% endif %} = {{ step.operand1_label }})
        {% endif %}
        {% if step.operand2_label %}
            ({% if step.operand2_display %}{{ step.operand2_display|floatformat:1 }} {{ step.operand2_display_unit }}{% else %}{{ step.operand2|floatformat:1 }} {{ step.operand2_unit }}{% endif %} = {{ step.operand2_label }})
        {% endif %}
    </div>
    {% endif %}
    <span class="calc-cell">
        {% if step.operand1_display %}
            {{ step.operand1_display|floatformat:1 }} {{ step.operand1_display_unit }}
        {% else %}
            {{ step.operand1|floatformat:1 }} {{ step.operand1_unit }}
        {% endif %}
        {{ step.operator }}
        {% if step.operand2_display %}
            {{ step.operand2_display|floatformat:1 }} {{ step.operand2_display_unit }}
        {% else %}
            {{ step.operand2|floatformat:1 }} {{ step.operand2_unit }}
        {% endif %}
        =
    </span>
    <span class="consumption-cell">
        <strong>{{ step.result|floatformat:1 }} {{ step.unit }}</strong>
    </span>
</div>
{% elif step.step_type == 'result' %}
{% comment %}Result step can be handled here if needed{% endcomment %}
{% endif %}
{% endfor %}

{% if contrib.consumption_result.calculation_str %}
<div class="calculation-step">
    <span class="calc-cell">{{ contrib.consumption_result.calculation_str_left }} =</span>
    <span class="consumption-cell"><strong>{{ contrib.consumption_result.calculation_result }}</strong></span>
</div>
{% endif %}
