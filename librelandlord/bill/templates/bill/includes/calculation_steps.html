{% comment %}Reusable calculation steps display for a contribution{% endcomment %}

{% comment %}
Kompakte Darstellung: Verschachtelte Berechnungen inline in Klammern
Beispiel: (16,0 m³ - 12,0 m³) * 28,6 % = 1,1 m³
{% endcomment %}

<!-- Zählerstände der verschachtelten Berechnungen anzeigen -->
{% for arg_result in contrib.consumption_result.argument_results %}
    {% if arg_result.source_type == 'nested_calculation' and arg_result.nested_result %}
        {% for nested_step in arg_result.nested_result.calculation_steps %}
            {% include 'bill/includes/meter_readings_table.html' with step=nested_step %}
        {% endfor %}
    {% endif %}
{% endfor %}

<!-- Normale Zählerstände der Hauptberechnung -->
{% for step in contrib.consumption_result.calculation_steps %}
{% include 'bill/includes/meter_readings_table.html' with step=step %}
{% endfor %}

<!-- Berechnungsschritte kompakt -->
{% for step in contrib.consumption_result.calculation_steps %}
{% if step.step_type == 'operation' %}
<div class="calculation-step step-{{ step.step_type }}">
    {% comment %}Erklärungen über der Formel (nur für Operand 2, z.B. Prozentanteil){% endcomment %}
    {% if step.operand2_label %}
    <div style="color: #666; font-style: italic; margin-bottom: 3px; font-size: 0.9em;">
        ({% if step.operand2_display %}{{ step.operand2_display|floatformat:1 }} {{ step.operand2_display_unit }}{% else %}{{ step.operand2|floatformat:1 }} {{ step.operand2_unit }}{% endif %} = {{ step.operand2_label }})
    </div>
    {% endif %}

    <span class="calc-cell">
        {% comment %}Prüfe ob Argument 1 eine verschachtelte Berechnung ist{% endcomment %}
        {% with first_arg=contrib.consumption_result.argument_results.0 %}
        {% if first_arg.source_type == 'nested_calculation' and first_arg.nested_result %}
            {% comment %}Zeige verschachtelte Berechnung inline in Klammern{% endcomment %}
            {% for nested_step in first_arg.nested_result.calculation_steps %}
                {% if nested_step.step_type == 'operation' %}
                    ({% if nested_step.operand1_display %}{{ nested_step.operand1_display|floatformat:1 }} {{ nested_step.operand1_display_unit }}{% else %}{{ nested_step.operand1|floatformat:1 }} {{ nested_step.operand1_unit }}{% endif %} {{ nested_step.operator }} {% if nested_step.operand2_display %}{{ nested_step.operand2_display|floatformat:1 }} {{ nested_step.operand2_display_unit }}{% else %}{{ nested_step.operand2|floatformat:1 }} {{ nested_step.operand2_unit }}{% endif %})
                {% endif %}
            {% endfor %}
        {% else %}
            {% comment %}Normaler Operand 1{% endcomment %}
            {% if step.operand1_display %}
                {{ step.operand1_display|floatformat:1 }} {{ step.operand1_display_unit }}
            {% else %}
                {{ step.operand1|floatformat:1 }} {{ step.operand1_unit }}
            {% endif %}
        {% endif %}
        {% endwith %}
        {{ step.operator }}
        {% if step.operand2_display %}
            {{ step.operand2_display|floatformat:1 }} {{ step.operand2_display_unit }}
        {% else %}
            {{ step.operand2|floatformat:1 }} {{ step.operand2_unit }}
        {% endif %}
        =
    </span>
    <span class="consumption-cell">
        <strong>{{ step.result|floatformat:1 }} {{ step.unit }}</strong>
    </span>
</div>
{% endif %}
{% endfor %}

{% if contrib.consumption_result.calculation_str %}
<div class="calculation-step">
    <span class="calc-cell">{{ contrib.consumption_result.calculation_str_left }} =</span>
    <span class="consumption-cell"><strong>{{ contrib.consumption_result.calculation_result }}</strong></span>
</div>
{% endif %}
