{% comment %}Reusable meter readings table for a calculation step with source_details.meters{% endcomment %}
{% if step.step_type == 'argument' and step.source_details and step.source_details.meters %}
<div class="section-group">
    <h5>Zählerstände {{ step.source_details.meter_place.name }}
        (Ort: {{ step.source_details.meter_place.location }})</h5>

    {% comment %}Erst die berechneten Werte identifizieren und nummerieren{% endcomment %}
    {% with footnote_counter=0 meter_footnotes=dict %}

    <table class="meter-readings-table">
        <thead>
            <tr>
                <th>Zähler Nr</th>
                <th>Von</th>
                <th>Bis</th>
                <th>Endstand</th>
                <th></th>
                <th>Anfangsstand</th>
                <th></th>
                <th>Verbrauch</th>
            </tr>
        </thead>
        <tbody>
            {% for meter_info in step.source_details.meters %}
            <tr>
                <td class="number-cell">{{ meter_info.meter_number }}</td>
                <td>{{ meter_info.start_reading.date|date:"d.m.Y" }}</td>
                <td>{{ meter_info.end_reading.date|date:"d.m.Y" }}</td>
                <td class="number-cell">
                    {{ meter_info.end_reading.calculated_reading|floatformat:0 }}
                    {{ step.source_details.meter_place.unit }}
                    {% if not meter_info.end_reading.is_exact %}
                    {% with footnote_counter|add:1 as footnote_counter %}
                    <sup>*{{ footnote_counter }}</sup>
                    {% endwith %}
                    {% endif %}
                </td>
                <td> - </td>
                <td class="number-cell">
                    {{ meter_info.start_reading.calculated_reading|floatformat:0 }}
                    {{ step.source_details.meter_place.unit }}
                    {% if not meter_info.start_reading.is_exact %}
                    {% with footnote_counter|add:1 as footnote_counter %}
                    <sup>*{{ footnote_counter }}</sup>
                    {% endwith %}
                    {% endif %}
                </td>
                <td>=</td>
                <td class="consumption-cell">
                    {% if meter_info.consumption %}
                    {{ meter_info.consumption|floatformat:0 }}
                    {{ step.source_details.meter_place.unit }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            <tr style="border-top:2px solid #333; background:#f8f9fa;">
                <td colspan="7" style="text-align: right; font-weight:bold;">
                    Summe
                </td>
                <td class="consumption-cell">
                    <strong>
                        {{ step.source_details.total_consumption|floatformat:0 }}
                        {{ step.source_details.meter_place.unit }}
                    </strong>
                </td>
            </tr>
        </tbody>
    </table>

    {% comment %}Hinweise zu berechneten Zählerständen{% endcomment %}
    {% if step.source_details.meters %}
        {% with footnote_num=0 %}
        {% for meter_info in step.source_details.meters %}
            {% if not meter_info.end_reading.is_exact or not meter_info.start_reading.is_exact %}
                {% if forloop.first %}
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; font-size: 0.9em;">
                    <strong>* Berechnete Zählerstände:</strong>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                {% endif %}

                {% if not meter_info.end_reading.is_exact %}
                {% with footnote_num|add:1 as footnote_num %}
                <li>
                    <strong>*{{ footnote_num }}</strong> Interpoliert zwischen {{ meter_info.end_reading.reading_before.meter_reading|floatformat:0 }} {{ step.source_details.meter_place.unit }} am {{ meter_info.end_reading.reading_before.date|date:"d.m.Y" }} und {{ meter_info.end_reading.reading_after.meter_reading|floatformat:0 }} {{ step.source_details.meter_place.unit }} am {{ meter_info.end_reading.reading_after.date|date:"d.m.Y" }} = {{ meter_info.end_reading.days_total }} Tage<br>
                    (Täglicher Verbrauch: {{ meter_info.end_reading.daily_consumption|floatformat:2 }} {{ step.source_details.meter_place.unit }}/Tag)<br>
                    Berechnung: {{ meter_info.end_reading.interpolation_formula }} = {{ meter_info.end_reading.calculated_reading|floatformat:0 }} {{ step.source_details.meter_place.unit }}
                </li>
                {% endwith %}
                {% endif %}

                {% if not meter_info.start_reading.is_exact %}
                {% with footnote_num|add:1 as footnote_num %}
                <li>
                    <strong>*{{ footnote_num }}</strong> Interpoliert zwischen {{ meter_info.start_reading.reading_before.meter_reading|floatformat:0 }} {{ step.source_details.meter_place.unit }} am {{ meter_info.start_reading.reading_before.date|date:"d.m.Y" }} und {{ meter_info.start_reading.reading_after.meter_reading|floatformat:0 }} {{ step.source_details.meter_place.unit }} am {{ meter_info.start_reading.reading_after.date|date:"d.m.Y" }} = {{ meter_info.start_reading.days_total }} Tage<br>
                    (Täglicher Verbrauch: {{ meter_info.start_reading.daily_consumption|floatformat:2 }} {{ step.source_details.meter_place.unit }}/Tag)<br>
                    Berechnung: {{ meter_info.start_reading.interpolation_formula }} = {{ meter_info.start_reading.calculated_reading|floatformat:0 }} {{ step.source_details.meter_place.unit }}
                </li>
                {% endwith %}
                {% endif %}

                {% if forloop.last %}
                    </ul>
                </div>
                {% endif %}
            {% endif %}
        {% endfor %}
        {% endwith %}
    {% endif %}

    {% endwith %}
</div>
{% endif %}
